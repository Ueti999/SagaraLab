# 3DM-CV7-AHRS + PMX-SCR-5204HV PD制御システム

## 🎯 このプログラムは何をするの？

このプログラムは、**姿勢センサー**（3DM-CV7-AHRS）で測定した角度を使って、**サーボモーター**（PMX-SCR-5204HV）を自動制御するシステムです。

例えば：
- センサーが傾きを検出 → モーターが自動で補正
- 目標角度を設定 → モーターがその角度を維持
- リアルタイムで100回/秒の高速制御

## 📦 必要なもの

### ハードウェア
1. **Teensy 4.1** マイコンボード
2. **3DM-CV7-AHRS** 姿勢センサー（IMU/AHRS）
3. **PMX-SCR-5204HV** サーボモーター
4. **USBケーブル** 2本
   - Type-A to Micro-B（PC ↔ Teensy）
   - センサー用USBケーブル
5. **電源** モーター駆動用（12-24V推奨）

### ソフトウェア
1. **Arduino IDE** (1.8.19以降)
2. **Teensyduino** アドオン
3. **必要なライブラリ**：
   - USBHost_t36（Teensyduinoに含まれる）
   - PmxHardSerialClass（PMXモーター用）
   - DataConvert（PMXモーター用）

## 🔌 接続方法

```
     [PC]
       |
       | USB Type-B (プログラム書き込み・シリアルモニタ)
       |
   [Teensy 4.1]
       |     |
       |     +-- USBホスト端子 --- [3DM-CV7-AHRS センサー]
       |         (基板裏面の5ピンヘッダー)
       |         ※通常のUSB Type-Bではありません！
       |
       +-- Serial1端子
           |
           | TX(1番) → モーターのRX
           | RX(0番) → モーターのTX
           | EN(31番) → モーターのEN
           | GND → GND
           |
       [PMX-SCR-5204HV モーター]
           |
       [電源 12-24V]
```

### ⚠️ 重要：USBホスト接続について

**センサーの接続先**：
- ✅ **正しい**: Teensy 4.1基板**裏面**の5ピンUSBホストヘッダー
- ❌ **間違い**: 通常のUSB Type-Bポート（これはPC接続用）

**USBホストヘッダーのピン配置**：
```
[Teensy 4.1 裏面]
  VUSB (5V)
  D-
  D+
  GND
  GND
```

**電源供給**：
- 場合によってはVUSBとVINをジャンパーで接続する必要があります
- センサーの緑LEDが点灯していてもデータ通信ができない場合は接続を確認

### ピン接続詳細

| Teensy 4.1 | PMX-SCR-5204HV | 説明 |
|------------|----------------|------|
| Pin 1 (TX1) | RX | データ送信 |
| Pin 0 (RX1) | TX | データ受信 |
| Pin 31 | EN | 通信制御 |
| GND | GND | グランド |

## 🚀 使い方

### 1. セットアップ
```bash
1. Arduino IDEを開く
2. ツール → ボード → "Teensy 4.1" を選択
3. ツール → ポート → Teensy のポートを選択
4. AHRS_PD_Motor_Control.ino を開く
5. アップロードボタンをクリック
```

### 2. 起動手順
```
1. Teensy 4.1の電源を入れる
2. LEDが3回点滅（起動確認）
3. シリアルモニタを開く（115200bps）
4. センサーをUSBホストポートに接続
5. "センサー検出！"のメッセージを確認
6. 自動的にPD制御が開始
```

### 3. 操作方法

シリアルモニタでキーボード入力：

| キー | 動作 |
|------|------|
| **+** | 目標角度を +10度 |
| **-** | 目標角度を -10度 |
| **0** | 目標角度を 0度にリセット |
| **c** | センサー設定を再送信 |
| **s** | 接続状態の詳細確認 |

## 🔄 システムの動作フロー

```
┌─────────────────────────────────────────────┐
│              システム起動                     │
│                   ↓                          │
│         ┌─────────────────┐                │
│         │   初期化処理     │                │
│         │ ・USBホスト起動  │                │
│         │ ・モーター設定   │                │
│         │ ・センサー設定   │                │
│         └────────┬────────┘                │
│                  ↓                          │
│    ┌──────────────────────────────┐        │
│    │    メインループ (100Hz)       │        │
│    │                               │        │
│    │  1. センサーデータ読み取り    │        │
│    │     ↓                        │        │
│    │  2. 現在の角度・角速度を取得  │        │
│    │     ↓                        │        │
│    │  3. PD制御計算               │        │
│    │     誤差 = 目標 - 現在        │        │
│    │     トルク = Kp×誤差 + Kd×速度│        │
│    │     ↓                        │        │
│    │  4. モーターへトルク指令送信  │        │
│    │     ↓                        │        │
│    │  (10ミリ秒後に繰り返し)      │        │
│    └──────────────────────────────┘        │
│                                             │
└─────────────────────────────────────────────┘
```

## ⚙️ PD制御とは？

**PD制御**は、目標値と現在値の差（誤差）を使って制御する方法です：

- **P（比例）制御**: 誤差が大きいほど強く修正
- **D（微分）制御**: 速い動きを抑えて振動を防ぐ

### 制御式
```
トルク = -Kp × (現在角度 - 目標角度) - Kd × 角速度

Kp = 8.0  （位置の誤差への反応の強さ）
Kd = 0.3  （振動を抑える強さ）
```

## 📊 シリアルモニタの表示

正常動作時の表示例：
```
===== AHRS + PMX PD制御システム起動 =====
システム初期化中...
USBホスト初期化...完了
モータ通信初期化...完了

[重要] 接続確認:
1. センサーはTeensy 4.1のUSBホストポート(5ピンヘッダー)に接続
2. 通常のUSBポート(Type-B)ではありません
3. USBホストの電源供給を確認
   - VUSBとVINをジャンパーで接続が必要な場合があります

コマンド:
  'c' - センサーを設定
  's' - 状態確認

USB Host Status: userial=true, connected=false

🔌 センサー検出！
VID: 0x199B, PID: 0x3071
センサー自動設定中...
===== センサー設定開始 =====
⚠️ 注意: センサーが既に設定されている可能性があります
Step 1: センサーをアイドル状態にする
Step 2: IMUフォーマット設定（ジャイロ @ 100Hz）
Step 3: AHRSフォーマット設定（オイラー角 @ 100Hz）
Step 4: IMU(0x80)とAHRS(0x82)ストリームを有効化
✅ センサー設定完了！
期待される出力:
  - 0x80パケット: ジャイロ(0x05)
  - 0x82パケット: オイラー角(0x05)

PD制御: 目標=0.0° 現在=2.3° 誤差=-2.3° トルク=-184mNm

=== システム状態 ===
センサー: 接続
目標角度: 0.0度
現在角度: Roll=1.2° Pitch=2.3° Yaw=45.6°
```

## 🛠️ トラブルシューティング

### センサーが検出されない（「センサー: 未接続」と表示される）

**最も多い原因：USBポートの接続間違い**

1. **接続ポートの確認**
   - ❌ 通常のUSB Type-Bポート（プログラム書き込み用）に接続している
   - ✅ Teensy 4.1**基板裏面**の5ピンUSBホストヘッダーに接続する

2. **デバッグ方法**
   - 's'キーを押して状態確認
   - `USBSerial: 未検出` → USBホスト接続の問題
   - `USBSerial: 検出` → センサーは認識されている

3. **USBホストの配線確認**
   ```
   USBホストヘッダー（基板裏面）:
   VUSB (5V) --- センサーの5V
   D-        --- センサーのD-
   D+        --- センサーのD+
   GND       --- センサーのGND
   ```

4. **電源供給の確認**
   - センサーの緑LEDが点灯 = 電源は供給されている
   - ただし、データ通信には正しいUSBホスト接続が必要
   - 必要に応じてVUSBとVINをジャンパー接続

5. **センサーの事前設定**
   - SensorConnectツールで設定済みの場合はそのまま動作
   - 未設定の場合は接続後に'c'キーで設定

### モーターが動かない
- Serial1の配線を確認（TX→RX、RX→TX）
- EN端子（31番ピン）の接続を確認
- モーターの電源が入っているか確認
- ボーレート設定が115200になっているか確認

### 制御が不安定
- Kp、Kdの値を調整してみてください
  - 振動する場合：Kdを大きく（0.3 → 0.5）
  - 反応が遅い場合：Kpを大きく（8.0 → 10.0）

### エラーメッセージ
| メッセージ | 意味 | 対処法 |
|-----------|------|--------|
| "センサー: 未接続" | USBホストでセンサーが検出されない | USBホストポート（基板裏面）への接続を確認 |
| "USBSerial: 未検出" | USBデバイスが認識されない | USBホストの配線と電源供給を確認 |
| "センサー切断" | センサーとの通信が途切れた | USB接続を確認 |
| "Motor write error" | モーターへの送信失敗 | 配線とID設定を確認 |
| "警告: バッファシフト実行" | データ受信が多すぎる | 正常動作、無視してOK |
| "USB Host Status: userial=false" | USBデバイスが検出されていない | USBホストポートへの接続を確認 |

## 📝 パラメータ調整

`AHRS_PD_Motor_Control.ino`の以下の値を変更できます：

```cpp
// PD制御ゲイン（29-30行目）
const double Kp = 8.0;    // 大きくすると反応が速くなる
const double Kd = 0.3;    // 大きくすると振動が抑えられる

// 制御周期（32行目）
const double CONTROL_PERIOD = 10;  // ミリ秒単位

// トルクリミット（33行目）
const int TORQUE_LIMIT = 16000;    // 最大トルク[mNm]
```

## 🎓 学習のポイント

このシステムで学べること：
1. **センサーフュージョン**: IMUとAHRSの違い
2. **リアルタイム制御**: 高速な制御ループの実装
3. **PID制御理論**: フィードバック制御の基礎
4. **通信プロトコル**: MIPプロトコルとPMXプロトコル

## 📚 参考資料

- [Teensy 4.1 公式ドキュメント](https://www.pjrc.com/store/teensy41.html)
- [3DM-CV7-AHRS データシート](https://www.microstrain.com/)
- [PMXシリーズ サーボモーター資料](https://kondo-robot.com/)
- [PID制御の基礎](https://ja.wikipedia.org/wiki/PID制御)

## ⚠️ 注意事項

1. **電源**: モーターには適切な電源（12-24V）を使用してください
2. **配線**: TX/RXは必ずクロス接続（TX→RX、RX→TX）
3. **トルクリミット**: モーター保護のため、16000mNmを超えないように設定済み
4. **緊急停止**: 異常時はTeensyの電源を切ってください

## 💡 拡張アイデア

- 複数軸の制御（ロール、ピッチ、ヨー）
- 自動ゲイン調整機能の追加
- データログ機能の実装
- WiFi/Bluetooth経由のリモート制御

---

**作成日**: 2025年1月
**バージョン**: 1.1
**更新日**: 2025年1月9日
**対応環境**: Teensy 4.1 + Arduino IDE

## 📋 更新履歴

### v1.1 (2025/01/09)
- USBホスト接続に関する詳細な説明を追加
- センサー未接続問題のトラブルシューティングを強化
- デバッグコマンド's'を追加
- USB接続状態の詳細表示機能を追加
- センサー設定コマンドの改善

### v1.0 (2025/01)
- 初版リリース